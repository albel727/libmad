#
# mad - MPEG audio decoder
# Copyright (C) 2000 Robert Leslie
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# $Id: Makefile.in,v 1.30 2000/09/10 22:04:17 rob Exp $
#

## ENVIRONMENT ################################################################

@SET_MAKE@

src =		@srcdir@
VPATH =		@srcdir@

prefix =	@prefix@
exec_prefix =	@exec_prefix@

BINDEST =	@bindir@
MANDEST =	@mandir@

INCDEST =	@includedir@
LIBDEST =	@libdir@

MANEXT =	1

INSTALL =	@INSTALL@
BININSTALL =	@INSTALL_PROGRAM@ -m 755
LIBINSTALL =	@INSTALL_DATA@

ACSUBDIRS =	@subdirs@

## COMPILATION ################################################################

CC =		@CC@
INCLUDES =	@CPPFLAGS@ -Ilibmad
DEFINES =	@DEFS@
LIBS =		@LIBS@

ARCH =		@ARCH@
DEBUGGER =	@DEBUGGER@
OPTIMIZER =	@OPTIMIZER@
PROFILER =	@PROFILER@

COPTS =		@CFLAGS@ -Wall $(ARCH) $(DEBUGGER) $(OPTIMIZER) $(PROFILER)
LDOPTS =	@LDFLAGS@ $(PROFILER) -Llibmad

## FLAGS ######################################################################

CFLAGS =	$(COPTS) $(INCLUDES) $(DEFINES)
LDFLAGS =	$(LDOPTS)

## OBJECTS ####################################################################

TARGETS =	madplay
AUDIO =		resample.o audio.o  \
		audio_raw.o audio_wave.o audio_null.o @AUDIO@
OBJS =		$(AUDIO) id3.o id3v2.o

LIBMAD =	libmad/libmad.a
INCMAD =	libmad/mad.h

DOCS1 =		madplay.1

## GENERIC RULES ##############################################################

all :: @MAKE_TARGETS@

all_lib :: $(LIBMAD) $(INCMAD)

check :: all
	@echo "No self-tests available."

default :: $(TARGETS)

install :: @INSTALL_TARGETS@

install_default :: all
	$(BININSTALL) $(TARGETS) "$(BINDEST)/."

	for file in $(DOCS1); do  \
		$(LIBINSTALL) $$file  \
		"$(MANDEST)/man$(MANEXT)/`basename $$file .1`.$(MANEXT)";  \
	done

install_lib :: all_lib
	$(LIBINSTALL) $(LIBMAD) "$(LIBDEST)/."
	$(LIBINSTALL) $(INCMAD) "$(INCDEST)/."

again :: clean all

clean ::
	for dir in $(ACSUBDIRS); do  \
		(cd $$dir && $(MAKE) $@);  \
	done

	rm -f $(TARGETS) *.o *.a gmon.* core

distclean :: clean
	for dir in $(ACSUBDIRS); do  \
		(cd $$dir && $(MAKE) $@);  \
	done

	rm -f config.status config.cache config.log config.h
	rm -f Makefile

maintainer-clean :: distclean
	for dir in . $(ACSUBDIRS); do  \
		rm -f $$dir/config.h.in $$dir/configure;  \
	done

dist :: $(INCMAD) id3v2.c
	for dir in . $(ACSUBDIRS); do  \
		(cd $$dir && $(MAKE) config.h.in configure);  \
	done

	$(MAKE) distclean

depend :: $(INCMAD)
	for dir in $(ACSUBDIRS); do  \
		(cd $$dir && $(MAKE) $@);  \
	done

	( sed -n -e '1,/^## DEPEND/p' Makefile.in;  \
	  echo;  \
	  $(CC) -MM $(INCLUDES) $(DEFINES) *.c;  \
	) > Makefile.in.new
	mv -f Makefile.in.new Makefile.in

## AUTOCONF RULES #############################################################

Makefile: config.status
	./config.status && touch .stamp/config.h

.stamp/config.h: config.status
	./config.status && touch .stamp/config.h

config.status: .stamp/configure .stamp/config.h.in Makefile.in
	./config.status --recheck

.stamp/configure: configure.in
	autoconf && touch .stamp/configure

.stamp/config.h.in: configure.in acconfig.h
	autoheader &&  \
	sed -e '/\$$''Id: /s/\$$//g' config.h.in >config.h.in.new &&  \
	mv -f config.h.in.new config.h.in &&  \
	touch .stamp/config.h.in

## BUILD RULES ################################################################

$(LIBMAD) $(INCMAD) ::
	cd libmad && $(MAKE)

id3v2.c: id3v2.gperf
	gperf -tCTonD -K id -N id3v2_hash -s -3 -k '*'  \
		id3v2.gperf | sed -e '/\$$''Id: /s/\$$//g' >$@

madplay: $(LIBMAD) $(OBJS) madplay.o
	$(CC) $(LDFLAGS) -o $@ madplay.o $(OBJS) -lmad $(LIBS)

madtime: $(LIBMAD) madtime.o
	$(CC) $(LDFLAGS) -o $@ madtime.o -lmad $(LIBS)

madmix: $(LIBMAD) $(OBJS) madmix.o
	$(CC) $(LDFLAGS) -o $@ madmix.o $(OBJS) -lmad $(LIBS)

minimad: $(LIBMAD) minimad.o
	$(CC) $(LDFLAGS) -o $@ minimad.o -lmad $(LIBS)

profile :: madplay gmon.out
	gprof madplay | less

gmon.out: madplay
	./madplay -vo pcm:/dev/null teststream.mpg

.c.s:
	$(CC) $(ARCH) $(OPTIMIZER) $(INCLUDES) $(DEFINES) -S $<

*.o *.s: Makefile

## DEPENDENCIES ###############################################################

audio.o: audio.c config.h audio.h libmad/mad.h
audio_empeg.o: audio_empeg.c config.h libmad/mad.h audio.h
audio_hex.o: audio_hex.c config.h libmad/mad.h audio.h
audio_null.o: audio_null.c config.h libmad/mad.h audio.h
audio_oss.o: audio_oss.c config.h libmad/mad.h audio.h
audio_raw.o: audio_raw.c config.h libmad/mad.h audio.h
audio_sun.o: audio_sun.c config.h libmad/mad.h audio.h
audio_wave.o: audio_wave.c config.h libmad/mad.h audio.h
audio_win32.o: audio_win32.c config.h libmad/mad.h audio.h
id3.o: id3.c config.h id3v2.h id3.h
id3v2.o: id3v2.c config.h id3.h id3v2.h
madmix.o: madmix.c config.h libmad/mad.h audio.h
madplay.o: madplay.c config.h libmad/mad.h audio.h resample.h id3.h
madtime.o: madtime.c config.h libmad/mad.h
minimad.o: minimad.c libmad/mad.h
resample.o: resample.c config.h resample.h libmad/mad.h
